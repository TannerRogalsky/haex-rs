<!DOCTYPE html>
<html>
<head>
	<title>Test</title>
</head>
<body>
	<script type="module">
		// Use ES module import syntax to import functionality from the module
		// that we have compiled.
		//
		// Note that the `default` import is an initialization function which
		// will "boot" the module and make it ready to use. Currently browsers
		// don't support natively imported WebAssembly as an ES module, but
		// eventually the manual initialization won't be required!
		import init, { Wrapper, KeyEvent, ResourcesWrapper } from './haex.js';

		let font_data_promise = fetch('./fonts/Inconsolata-Regular.ttf').then(r => r.arrayBuffer());
		let sprites = new Image();
		sprites.src = './images/sprites.png';
		let sprites_data_promise = sprites.decode();
		let noise = new Image();
		noise.src = './images/noise.png';
		let noise_data_promise = noise.decode();
		let sprites_metadata_promise = fetch('./images/sprites.json').then(r => r.arrayBuffer());
		let aesthetic_promise = fetch('./shaders/aesthetic.glsl').then(r => r.text());
		let menu_promise = fetch('./shaders/menu.glsl').then(r => r.text());
		let music = document.createElement('audio');
		music.preload = 'auto';
		music.src = './sounds/music.ogg';

		async function run() {
			await init();

			let canvas = document.getElementById("game");

			let keyToCode = (key) => {
				if (key === "w") {
					return KeyEvent.W;
				} else if (key === "a") {
					return KeyEvent.A;
				}  else if (key === "s") {
					return KeyEvent.S;
				}  else if (key === "d") {
					return KeyEvent.D;
				}  else if (key === " ") {
					return KeyEvent.Space;
				}
			}

			let isLeft = (button) => {
				if (button === 0) {
					return true;
				} else if (button === 2) {
					return false;
				}
			}

			canvas.addEventListener('keydown', (event) => {
				let key_code = keyToCode(event.key);
				if (key_code !== undefined && game) {
					game.handle_key_down(key_code);
				}
			});

			canvas.addEventListener('keyup', (event) => {
				let key_code = keyToCode(event.key);
				if (key_code !== undefined && game) {
					game.handle_key_up(key_code);
				}
			});

			canvas.addEventListener('mousedown', (event) => {
				let button = isLeft(event.button);
				if (button !== undefined && game) {
					game.handle_mouse_down(button);
				}
			});

			canvas.addEventListener('mousemove', (event) => {
				if (game) {
					game.handle_mouse_move(event.offsetX, event.offsetY);
				}
			});

			canvas.oncontextmenu = (event) => {
				event.preventDefault();
				event.stopPropagation();
				return false;
			};

			window.addEventListener('mouseup', (event) => {
				let button = isLeft(event.button);
				if (button !== undefined) {
					game.handle_mouse_up(button);
				}
			});

			canvas.addEventListener('fullscreenchange', (event) => {
				if (document.fullscreenElement !== canvas) {
					canvas.width = 1280;
					canvas.height = 720;
					if (game) {
						game.handle_resize();
					}
				}
			});

			let font_data = new Uint8Array (await font_data_promise);
			let sprites_metadata = new Uint8Array(await sprites_metadata_promise);
			await sprites_data_promise;
			await noise_data_promise;

			let resources = new ResourcesWrapper();
			resources.set_debug_font_data(font_data);
			resources.set_sprites(sprites);
			resources.set_sprites_metadata(sprites_metadata);
			resources.set_noise(noise);
			resources.set_aesthetic_shader(await aesthetic_promise);
			resources.set_menu_shader(await menu_promise);
			resources.set_music(music);

			let time = performance.now();
			let game = new Wrapper(canvas, time, resources);

			let resizeObserver = new ResizeObserver((entries) => {
				canvas.width = canvas.clientWidth;
				canvas.height = canvas.clientHeight;
					game.handle_resize();
			});
			resizeObserver.observe(canvas);

			let loop = () => {
				game.step(performance.now());
				requestAnimationFrame(loop);
			}
			requestAnimationFrame(loop);
		}

		run();
	</script>
	<script type="text/javascript">
		function rfs() {
			let canvas = document.getElementById("game");
			canvas.requestFullscreen({
				navigationUI: 'hide'
			});
		}
	</script>
<canvas id="game" width="1280" height="720" tabindex="1"></canvas>
<button onclick="rfs()">Fullscreen</button>
</body>
</html>